<!doctype html>
<html>
<body onclick='test().then(_=>terminate0())' style='height: 1000px;'>
<a href='https://www.yay.com/' id='target'>YAY</a>
<a href='https://wasm-feature-detect.surma.technology/'>WASM test</a>
<p onclick='home()'>home</p>
<p onclick='test()'>test</p>
<p onclick='boom()'>boom</p>
<p onclick='exit()'>exit</p>
<p onclick='terminate()' style="background:gray;width:500px;height:500px">terminate</p>
<!--    <script src="more.js">/*not allowed to load local resource*/</script>-->
<script> // errors here fail silently :(
function terminate0() {
    console.log("terminate0 disabled: enable by removing 0");
}

function print(...x) {
    log(...x);// to stdout and window title!
    console.log(...x);
}

function boom() {
    print('boom')
    target.innerHTML += " CONTENTS";// WORKS (only iff there is 1 id='target' !!)
}

window.onload = function () {
    test()
};
</script>

<p id="message">RUNNING WASM TESTS</p>
<script type="text/javascript">
    ignore = x => x
    nop = x => ignore(x)

    let memory_size = 100// pages Ã  __kb  65536 // 4GB!
    let memoryBase = 1024 * 16
    let table_size = 294

    function loadBytes(byte_start, len) {
        print("TODO loadBytes")
        return new Uint8Array(start);
    }

    function trimStack(x) {
        return x
    }

    let backtrace = function (print = 1) {
        try {
            throw new Error()
        } catch (ex) {
            if (print) console.error(trimStack(ex, 1)); else return trimStack(ex)
        }
    }

    function raise(msg) {
        print(msg)
        exit(0)
    }

    let memset = function (ptr, value, num) {
        memory[ptr] = value// ?
        log('todo("memset")', ptr, value, num)
        raise("memset should be part of wasp!?!")
    }

    async function wasmx(code) {
        try {
            let memory = new WebAssembly.Memory({initial: memory_size, maximum: memory_size});
            let table = new WebAssembly.Table({initial: table_size, maximum: table_size, element: "anyfunc"});
            let imports = {
                wasi_unstable: {proc_exit: terminate},
                env: {
                    memory,
                    logs: log,
                    logi: log,
                    logc: log,
                    printf: log,
                    puts: log,
                    putchar: log,
                    panic: terminate,
                    raise,
                    memset,
                    _ZSt9terminatev: terminate,
                    __cxa_begin_catch: nop,
                    _Z4emit4NodeP6Module6String: nop,
                    _Z10merge_wasm6ModuleS_: nop,
                    _Z8run_wasmPhi: (bytes, len) => wasmx(loadBytes(bytes, len)),// full circle yay!
                    memory,
                    table,
                    ext_memcpy: nop,
                    sum: (x, y) => x + y,
                }
            };
            log("STARTING WASM!");
            let module = await WebAssembly.compile(code)// global
            // instance = await WebAssembly.instantiate(module, imports, memory).catch(ex => console.error(trimStack(ex)) || quit())
            //const module = await WebAssembly.compileStreaming(fetch('program.wasm'));
            const instance = await WebAssembly.instantiate(module, imports, memory);
            //const { instance } = await WebAssembly.instantiateStreaming(fetch('program.wasm'));
            print("Exports: ", instance.exports);//show what we've got
            if (instance.exports.main) {
                result = instance.exports.main()
                wasm_done(result);
            } else {
                wasm_error("NO MAIN!");
            }
        } catch (error) {
            print('COMPILE ERROR', error.message)
            wasm_error(error.message);
        }
    }
</script>
</body>

